import paramiko

from u_45.enum import DIAGNOSIS_TYPE, DIAGNOSIS_CONDITIONS, EXECUTE_COMMAND
from common.module import _check_criterias, _execute_command, _get_condition_type_diagnosis_result, _get_exist_type_diagnosis_result, _has_comment

def diagnosis(client: paramiko.SSHClient, os) -> tuple[bool, dict]:
    commands = _get_execute_commands(os)
    conditions = _get_diagnosis_conditions(os)
    
    diagnosis_result = [
        {
            "target": condition["check"],
            "diagnosis": _get_condition_type_diagnosis_result(client, f"cat {condition['filepath']} | grep -i '{condition['check']}'", condition["criterias"])
        } if condition["type"] == DIAGNOSIS_TYPE.CONDITION else
        {
            "target": condition["check"],
            "diagnosis": _get_exist_type_diagnosis_result(client, f"cat {condition['filepath']} | grep -i '{condition['check']}'")
        } if condition["type"] == DIAGNOSIS_TYPE.EXIST else
        {
            "target": condition["check"],
            "diagnosis": _get_sudo_condition_diagsnosis_result(client, f"cat {condition['filepath']} | grep -i '{condition['check']}'", condition["criterias"])
        } if condition["type"] == DIAGNOSIS_TYPE.SUDO_CONDITION else
        {
            "target": f"check auth in '{condition['filepath']}'",
            "diagnosis": _get_check_auth_diagnosis_result(client, f"ls -al {condition['filepath']}", condition["criterias"])
        }
        for condition in conditions
    ]

    execute_commans_result = [
        {
            "target": command,
            "diagnosis": _get_execute_command_diagosis_result(client, command)
        }
        for command in commands
    ]

    diagnosis_result += execute_commans_result

    abnormal_result = all([result["diagnosis"]["result"] for result in diagnosis_result if result["diagnosis"] is not None and not result["diagnosis"]["result"]])
    
    return abnormal_result, diagnosis_result

def _get_diagnosis_conditions(os: str) -> list[dict]:
    return DIAGNOSIS_CONDITIONS[os.upper()].value

def _get_execute_commands(os: str) -> list[str]:
    return EXECUTE_COMMAND[os.upper()].value

def _get_sudo_condition_diagsnosis_result(client: paramiko.SSHClient, command, criterias: dict) -> dict:
    find_result = _execute_command(command)
    diagnosis_result = None

    if _has_comment(find_result):
        find_result = ""

    target = find_result.split(":")[0].strip()
    parsed_target = None if find_result == "" else f"'{target}'"

    if parsed_target is not None:
        diagnosis_result = _check_criterias(parsed_target, criterias)
    
    return{
        "result": diagnosis_result,
        "target": parsed_target,
        "criterias": criterias
    }

def _get_check_auth_diagnosis_result(client: paramiko.SSHClient, command, criterias: dict) -> dict:
    find_result = _execute_command(command)
    diagnosis_result = None
    
    target = find_result.split(" ")[0].strip()
    parsed_target = None if find_result == "" else f"'{target}'"

    if parsed_target is not None:
        diagnosis_result = _check_criterias(parsed_target, criterias)
    
    return {
        "result": diagnosis_result,
        "target": parsed_target,
        "criterias": criterias
    }

def _get_execute_command_diagosis_result(client: paramiko.SSHClient, command) -> dict:
    find_result = _execute_command(command)
    diagnosis_result = None

    if _has_comment(find_result):
        find_result = None
    
    diagnosis_result = True if find_result else False

    return {
        "result": diagnosis_result,
        "target": f"execute command '{command}'",
        "criterias": "execute command"
    }