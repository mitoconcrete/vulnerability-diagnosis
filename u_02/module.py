import paramiko

from u_02.enum import DIAGNOSIS_CONDITION

from common.dto import DiagnosisResult
from common.type import DiagnosisCondition
from common.module import _evaluate_final_result, _get_diagnosis_result


def diagnosis(client: paramiko.SSHClient, os: str, version: int = -1) -> tuple[bool, list[DiagnosisResult]]:
    conditions = _get_diagnosis_conditions(os)
    diagnosis_results: list[DiagnosisResult] = []

    for condition in conditions:
        command = f"cat {condition.filepath} | grep -i '{condition.target}'"
        result = _get_diagnosis_result(client, command, condition.criterias)
        diagnosis_results.append(result)

    final_result = _evaluate_final_result(diagnosis_results)
    
    return final_result, diagnosis_results

def _get_diagnosis_conditions(os: str) -> list[DiagnosisCondition]:
    return DIAGNOSIS_CONDITION[os].value
