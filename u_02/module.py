import paramiko

from u_02.enum import DIAGNOSIS_CONDITIONS
from common.module import _get_condition_type_diagnosis_result


def diagnosis(client: paramiko.SSHClient, os: str) -> tuple[bool, dict]:
    conditions = _get_diagnosis_conditions(os)

    diagnosis_result = [{
        "target": condition["check"],
        "diagnosis": _get_condition_type_diagnosis_result(client, f"cat {condition["filepath"]} | grep -i '{condition["check"]}'", condition["criterias"]) 
    } for condition in conditions]

    abnormal_result = all([result["diagnosis"]["result"] for result in diagnosis_result if result["diagnosis"] is not None and not result["diagnosis"]["result"]])
    
    return abnormal_result, diagnosis_result

def _get_diagnosis_conditions(os: str) -> dict:
    return DIAGNOSIS_CONDITIONS[os.upper()].value
